name: CI/CD Pipeline - Ø®Ø¯Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'
  POSTGRES_VERSION: '15'
  REDIS_VERSION: '7.0'

jobs:
  test:
    name: ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ÙƒÙˆØ¯
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: test_naebak_messaging
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7.0
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
    
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-test.txt
    
    - name: ğŸ” ÙØ­Øµ Ø¬ÙˆØ¯Ø© Ø§Ù„ÙƒÙˆØ¯
      run: |
        flake8 messages/ --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 messages/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: ğŸ§ª ØªØ´ØºÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
      env:
        DATABASE_URL: postgres://postgres:postgres@localhost:5432/test_naebak_messaging
        REDIS_URL: redis://localhost:6379/0
        SECRET_KEY: test-secret-key-for-ci
        DEBUG: False
      run: |
        python manage.py collectstatic --noinput
        python manage.py migrate --settings=messaging_service.test_settings
        python -m pytest tests/ --cov=messages --cov-report=xml --cov-report=term-missing
    
    - name: ğŸ“Š Ø±ÙØ¹ ØªØºØ·ÙŠØ© Ø§Ù„ÙƒÙˆØ¯
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  security:
    name: ğŸ”’ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
    
    - name: ğŸ Ø¥Ø¹Ø¯Ø§Ø¯ Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: ğŸ”’ ÙØ­Øµ Ø§Ù„Ø«ØºØ±Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©
      run: |
        pip install safety bandit
        safety check --json
        bandit -r messages/ -f json
    
    - name: ğŸ” ÙØ­Øµ Ø§Ù„ØªØ¨Ø¹ÙŠØ§Øª
      run: |
        pip install pip-audit
        pip-audit --format=json

  build:
    name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ Docker Image
    runs-on: ubuntu-latest
    needs: [test, security]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
    
    - name: ğŸ³ Ø¥Ø¹Ø¯Ø§Ø¯ Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: ğŸ—ï¸ Ø¨Ù†Ø§Ø¡ ÙˆØ±ÙØ¹ Docker Image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          naebak/messaging-service:latest
          naebak/messaging-service:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: ğŸš€ Ù†Ø´Ø± Ø§Ù„Ø®Ø¯Ù…Ø©
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Ø§Ø³ØªÙ†Ø³Ø§Ø® Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
    
    - name: ğŸš€ Ù†Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          cd /opt/naebak-messaging-service
          git pull origin main
          docker-compose pull
          docker-compose up -d --no-deps messaging-service
          docker-compose exec -T messaging-service python manage.py migrate
          docker-compose exec -T messaging-service python manage.py collectstatic --noinput
    
    - name: ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø´Ø±
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#deployments'
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
        message: |
          ğŸš€ ØªÙ… Ù†Ø´Ø± Ø®Ø¯Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ù†Ø¬Ø§Ø­!
          ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${{ github.sha }}
          ğŸŒ Ø§Ù„Ø¨ÙŠØ¦Ø©: Ø§Ù„Ø¥Ù†ØªØ§Ø¬
          â° Ø§Ù„ÙˆÙ‚Øª: ${{ github.event.head_commit.timestamp }}

  notification:
    name: ğŸ”” Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    runs-on: ubuntu-latest
    needs: [test, security, build, deploy]
    if: always()
    
    steps:
    - name: ğŸ“§ Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 587
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "Ù†ØªØ§Ø¦Ø¬ CI/CD - Ø®Ø¯Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„"
        body: |
          Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙØ±ÙŠÙ‚ Ø§Ù„ØªØ·ÙˆÙŠØ±ØŒ
          
          ØªÙ… ØªØ´ØºÙŠÙ„ pipeline CI/CD Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:
          
          ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª: ${{ needs.test.result }}
          ğŸ”’ Ù†ØªØ§Ø¦Ø¬ ÙØ­Øµ Ø§Ù„Ø£Ù…Ø§Ù†: ${{ needs.security.result }}
          ğŸ—ï¸ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ù†Ø§Ø¡: ${{ needs.build.result }}
          ğŸš€ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ø´Ø±: ${{ needs.deploy.result }}
          
          ğŸ“¦ Ø§Ù„ÙƒÙˆÙ…ÙŠØª: ${{ github.sha }}
          ğŸŒ¿ Ø§Ù„Ø¨Ø±Ø§Ù†Ø´: ${{ github.ref }}
          ğŸ‘¤ Ø§Ù„Ù…Ø·ÙˆØ±: ${{ github.actor }}
          
          ØªØ­ÙŠØ§ØªÙŠØŒ
          Ù†Ø¸Ø§Ù… CI/CD - Ù…Ù†ØµØ© Ù†Ø§Ø¦Ø¨Ùƒ.ÙƒÙˆÙ…
        to: ${{ secrets.NOTIFICATION_EMAIL }}
        from: noreply@naebak.com
